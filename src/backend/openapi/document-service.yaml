openapi: 3.1.0
info:
  title: AUSTA Health Portal Document Service API
  version: 1.0.0
  description: |
    Secure document management service for the AUSTA Pre-paid Health Plan Onboarding Portal.
    Provides encrypted document storage with LGPD compliance and audit trails.
  contact:
    name: AUSTA Development Team
    email: dev-team@austa.com.br

servers:
  - url: /api/v1
    description: Document service API endpoint

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token for authentication

  schemas:
    DocumentMetadata:
      type: object
      required:
        - id
        - enrollmentId
        - documentType
        - filename
        - contentType
        - size
        - encryptionType
        - status
      properties:
        id:
          type: string
          format: uuid
          description: Unique document identifier
          example: "550e8400-e29b-41d4-a716-446655440000"
        enrollmentId:
          type: string
          format: uuid
          description: Associated enrollment ID
          example: "650e8400-e29b-41d4-a716-446655440001"
        documentType:
          type: string
          enum: [ID, CPF, ADDRESS_PROOF, MEDICAL_RECORD]
          description: Type of document
          example: "ID"
        filename:
          type: string
          description: Original filename
          example: "passport.pdf"
        contentType:
          type: string
          description: MIME type of the document
          example: "application/pdf"
        size:
          type: integer
          format: int64
          description: File size in bytes
          example: 1048576
        encryptionType:
          type: string
          description: Encryption algorithm used
          example: "AES-256"
        status:
          type: string
          enum: [PROCESSING, READY, ERROR]
          description: Document processing status
          example: "READY"
        retentionPeriod:
          type: string
          description: LGPD-compliant data retention period
          example: "5 years"
        createdAt:
          type: string
          format: date-time
          description: Document upload timestamp
          example: "2025-11-11T10:30:00Z"
        updatedAt:
          type: string
          format: date-time
          description: Last update timestamp
          example: "2025-11-11T10:30:05Z"

    DocumentUploadRequest:
      type: object
      required:
        - enrollmentId
        - documentType
        - consentToken
        - file
      properties:
        enrollmentId:
          type: string
          format: uuid
          description: Associated enrollment ID
          example: "650e8400-e29b-41d4-a716-446655440001"
        documentType:
          type: string
          enum: [ID, CPF, ADDRESS_PROOF, MEDICAL_RECORD]
          description: Type of document being uploaded
          example: "ID"
        consentToken:
          type: string
          description: LGPD consent token
          example: "consent-token-12345"
        file:
          type: string
          format: binary
          description: Document file to upload

    Error:
      type: object
      required:
        - code
        - message
        - traceId
      properties:
        code:
          type: string
          description: Error code
          example: "INVALID_FILE"
        message:
          type: string
          description: Human-readable error message
          example: "Failed to process file upload"
        details:
          type: object
          description: Additional error details
          additionalProperties: true
        traceId:
          type: string
          format: uuid
          description: Trace ID for debugging
          example: "850e8400-e29b-41d4-a716-446655440003"

  responses:
    Unauthorized:
      description: Authentication required or token expired
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: "UNAUTHORIZED"
            message: "Authentication token is missing or invalid"
            traceId: "850e8400-e29b-41d4-a716-446655440003"

    Forbidden:
      description: Insufficient permissions for the requested operation
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: "FORBIDDEN"
            message: "You don't have permission to access this resource"
            traceId: "850e8400-e29b-41d4-a716-446655440003"

    NotFound:
      description: Requested document not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: "DOCUMENT_NOT_FOUND"
            message: "Document not found"
            traceId: "850e8400-e29b-41d4-a716-446655440003"

    TooManyRequests:
      description: Rate limit exceeded
      headers:
        X-RateLimit-Limit:
          schema:
            type: integer
          description: Request limit per hour
        X-RateLimit-Remaining:
          schema:
            type: integer
          description: Remaining requests in current window
        X-RateLimit-Reset:
          schema:
            type: integer
            format: unix-timestamp
          description: Time when rate limit resets
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: "RATE_LIMIT_EXCEEDED"
            message: "Too many requests. Please try again later."
            traceId: "850e8400-e29b-41d4-a716-446655440003"

paths:
  /documents:
    post:
      summary: Upload a new document
      description: |
        Uploads a new document with encryption and LGPD compliance.
        Documents are encrypted using AES-256 before storage.
        Maximum file size is 10MB.
      operationId: uploadDocument
      security:
        - bearerAuth: []
      tags:
        - Document Management
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/DocumentUploadRequest'
            encoding:
              file:
                contentType: application/pdf, image/jpeg, image/png, application/msword
      responses:
        '201':
          description: Document uploaded successfully
          headers:
            X-Processing-Time:
              schema:
                type: integer
              description: Processing time in milliseconds
            X-Document-ID:
              schema:
                type: string
                format: uuid
              description: ID of the uploaded document
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DocumentMetadata'
              example:
                id: "550e8400-e29b-41d4-a716-446655440000"
                enrollmentId: "650e8400-e29b-41d4-a716-446655440001"
                documentType: "ID"
                filename: "passport.pdf"
                contentType: "application/pdf"
                size: 1048576
                encryptionType: "AES-256"
                status: "READY"
                retentionPeriod: "5 years"
                createdAt: "2025-11-11T10:30:00Z"
                updatedAt: "2025-11-11T10:30:05Z"
        '400':
          description: Invalid upload data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalidEnrollmentId:
                  value:
                    code: "INVALID_ENROLLMENT_ID"
                    message: "Invalid enrollment ID format"
                    traceId: "850e8400-e29b-41d4-a716-446655440003"
                invalidDocumentType:
                  value:
                    code: "INVALID_DOCUMENT_TYPE"
                    message: "Invalid document type"
                    traceId: "850e8400-e29b-41d4-a716-446655440003"
                missingConsent:
                  value:
                    code: "MISSING_CONSENT"
                    message: "LGPD consent token is required"
                    traceId: "850e8400-e29b-41d4-a716-446655440003"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '413':
          description: File too large
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: "FILE_TOO_LARGE"
                message: "File size exceeds maximum limit of 10MB"
                traceId: "850e8400-e29b-41d4-a716-446655440003"
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                encryptionFailed:
                  value:
                    code: "ENCRYPTION_FAILED"
                    message: "Failed to process file"
                    traceId: "850e8400-e29b-41d4-a716-446655440003"
                uploadFailed:
                  value:
                    code: "UPLOAD_FAILED"
                    message: "Failed to store file"
                    traceId: "850e8400-e29b-41d4-a716-446655440003"

  /documents/{id}:
    get:
      summary: Retrieve a document
      description: |
        Retrieves and decrypts a document by its ID.
        Returns the decrypted file with integrity verification.
      operationId: getDocument
      security:
        - bearerAuth: []
      tags:
        - Document Management
      parameters:
        - name: id
          in: path
          required: true
          description: Document ID
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: Document retrieved successfully
          headers:
            X-Encryption-Type:
              schema:
                type: string
              description: Encryption algorithm used
              example: "AES-256"
            X-Content-Hash:
              schema:
                type: string
              description: SHA-256 hash of the content
              example: "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"
          content:
            application/pdf:
              schema:
                type: string
                format: binary
            image/jpeg:
              schema:
                type: string
                format: binary
            image/png:
              schema:
                type: string
                format: binary
        '400':
          description: Invalid document ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: "INVALID_ID"
                message: "Invalid document ID format"
                traceId: "850e8400-e29b-41d4-a716-446655440003"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                decryptionFailed:
                  value:
                    code: "DECRYPTION_FAILED"
                    message: "Failed to process document"
                    traceId: "850e8400-e29b-41d4-a716-446655440003"
                hashCalculationFailed:
                  value:
                    code: "HASH_CALCULATION_FAILED"
                    message: "Failed to verify document integrity"
                    traceId: "850e8400-e29b-41d4-a716-446655440003"

security:
  - bearerAuth: []

tags:
  - name: Document Management
    description: Secure document upload and retrieval with encryption

x-performance-slo:
  processing-time: 5000  # 5 seconds target for 90% of requests
  availability: 99.9
  max-file-size: 10485760  # 10MB in bytes
  rate-limits:
    default: 1000
    upload: 100
